<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoStream - Gana XLM viendo videos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Login Page Styles */
        .login-page {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .login-container {
            background: white;
            padding: 3rem;
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            text-align: center;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .logo {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        h1 {
            color: #667eea;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #666;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .stellar-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, #7b16ff, #b116ff);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            margin-bottom: 2rem;
            font-weight: bold;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
        }

        .btn-freighter {
            background: linear-gradient(135deg, #7b16ff, #b116ff);
            color: white;
        }

        .btn-freighter:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(123, 22, 255, 0.4);
        }

        .btn-freighter:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 2rem 0;
            color: #999;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #ddd;
        }

        .divider span {
            padding: 0 1rem;
        }

        .info-box {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 15px;
            margin-top: 2rem;
            text-align: left;
        }

        .info-box h3 {
            color: #667eea;
            margin-bottom: 1rem;
        }

        .info-box ul {
            list-style: none;
            padding-left: 0;
        }

        .info-box li {
            padding: 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .download-link {
            margin-top: 2rem;
            color: #999;
            font-size: 0.9rem;
        }

        .download-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
        }

        .loading {
            display: none;
            margin-top: 1rem;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Dashboard Styles */
        .dashboard-page {
            display: none;
            background: #0f0f23;
            color: white;
            min-height: 100vh;
        }

        .navbar {
            background: rgba(15, 15, 35, 0.95);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #667eea;
            backdrop-filter: blur(10px);
        }

        .nav-logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .balance {
            background: linear-gradient(135deg, #7b16ff, #b116ff);
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            font-weight: bold;
        }

        .btn-logout {
            background: #e74c3c;
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-logout:hover {
            background: #c0392b;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid #667eea;
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #999;
            margin-top: 0.5rem;
        }

        h2 {
            color: #667eea;
            margin-bottom: 1.5rem;
            font-size: 2rem;
        }

        .videos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
        }

        .video-card {
            background: rgba(102, 126, 234, 0.05);
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .video-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .video-thumbnail {
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            position: relative;
        }

        .play-button {
            position: absolute;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .video-info {
            padding: 1.5rem;
        }

        .video-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .video-meta {
            display: flex;
            justify-content: space-between;
            color: #999;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .reward-badge {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        /* Video Player Styles */
        .video-page {
            display: none;
            background: #000;
            min-height: 100vh;
        }

        .video-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .video-header {
            background: rgba(15, 15, 35, 0.95);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .video-player {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            position: relative;
            font-size: 15rem;
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 8px;
            background: rgba(0,0,0,0.3);
        }

        .progress-fill {
            height: 100%;
            background: #27ae60;
            width: 0%;
            transition: width 0.3s;
        }

        .controls {
            background: rgba(15, 15, 35, 0.95);
            padding: 2rem;
            color: white;
            text-align: center;
        }

        .timer {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .reward-info {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            padding: 1rem 2rem;
            border-radius: 25px;
            display: inline-block;
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .btn-back {
            background: #e74c3c;
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-back:hover {
            background: #c0392b;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            min-width: 300px;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success { border-left: 4px solid #27ae60; color: #27ae60; }
        .notification.error { border-left: 4px solid #e74c3c; color: #e74c3c; }
        .notification.info { border-left: 4px solid #3498db; color: #3498db; }

        @media (max-width: 600px) {
            .login-container {
                padding: 2rem;
            }
            h1 {
                font-size: 2rem;
            }
            .navbar {
                flex-direction: column;
                gap: 1rem;
            }
            .user-info {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-page" id="loginPage">
        <div class="login-container">
            <div class="logo">üì∫</div>
            <h1>CRYPTOSTREAM</h1>
            <p class="subtitle">Gana XLM viendo videos</p>
            
            <div class="stellar-badge">
                ‚≠ê Powered by Stellar Network
            </div>

            <div>
                <button class="btn btn-freighter" onclick="app.connectFreighter()" id="connectBtn">
                    üîó Conectar con Freighter Wallet
                </button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 1rem; color: #667eea;">Conectando...</p>
            </div>

            <div class="divider">
                <span>¬øPor qu√© Freighter?</span>
            </div>

            <div class="info-box">
                <h3>‚ú® Caracter√≠sticas</h3>
                <ul>
                    <li>‚ö° Transacciones instant√°neas</li>
                    <li>üîí 100% seguro y descentralizado</li>
                    <li>üí∞ Recibe XLM directamente</li>
                    <li>üåê Sin intermediarios</li>
                </ul>
            </div>

            <p class="download-link">
                ¬øNo tienes Freighter? 
                <a href="https://www.freighter.app/" target="_blank">
                    Desc√°rgalo aqu√≠ ‚Üí
                </a>
            </p>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div class="dashboard-page" id="dashboardPage">
        <nav class="navbar">
            <div class="nav-logo">
                <span>üì∫</span> CRYPTOSTREAM
            </div>
            <div class="user-info">
                <div class="balance" id="balanceDisplay">
                    üí∞ Cargando...
                </div>
                <button class="btn-logout" onclick="app.logout()">
                    üö™ Salir
                </button>
            </div>
        </nav>

        <div class="container" id="mainContainer">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="videosWatched">0</div>
                    <div class="stat-label">Videos Vistos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalEarned">0 XLM</div>
                    <div class="stat-label">Total Ganado</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">10,000+</div>
                    <div class="stat-label">Videos Disponibles</div>
                </div>
            </div>

            <h2>üé¨ Videos Disponibles</h2>
            <div class="videos-grid" id="videosGrid"></div>
        </div>
    </div>

    <!-- Video Player Page -->
    <div class="video-page" id="videoPage">
        <div class="video-container">
            <div class="video-header">
                <div>
                    <h2 id="videoTitle">üì∫ Cargando...</h2>
                </div>
                <div style="font-size: 1.2rem;" id="videoReward">‚≠ê Recompensa: 0 XLM</div>
            </div>
            <div class="video-player" id="player">
                <span id="videoEmoji">üé¨</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            <div class="controls">
                <div class="timer" id="timer">00:00</div>
                <div class="reward-info" id="rewardInfo">
                    ‚è≥ Mira el video completo para recibir tu recompensa
                </div>
                <div>
                    <button class="btn-back" onclick="app.goToDashboard()">‚¨ÖÔ∏è Volver</button>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/11.2.2/stellar-sdk.min.js"></script>
    <script>
        const app = {
            publicKey: null,
            server: null,
            currentVideoId: null,
            videoInterval: null,
            timeWatched: 0,

            videos: [
                { id: 1, title: "Tutorial Stellar Blockchain", duration: 330, reward: 0.5, emoji: "üåü", category: "Educaci√≥n" },
                { id: 2, title: "C√≥mo usar Freighter Wallet", duration: 225, reward: 0.3, emoji: "üíº", category: "Tutorial" },
                { id: 3, title: "Tecnolog√≠a Blockchain Explicada", duration: 500, reward: 0.8, emoji: "‚õìÔ∏è", category: "Educaci√≥n" },
                { id: 4, title: "Introducci√≥n a las Criptomonedas", duration: 375, reward: 0.6, emoji: "üí∞", category: "Educaci√≥n" },
                { id: 5, title: "Smart Contracts en Stellar", duration: 420, reward: 0.7, emoji: "üìù", category: "Avanzado" },
                { id: 6, title: "Historia de Bitcoin", duration: 270, reward: 0.4, emoji: "‚Çø", category: "Historia" },
                { id: 7, title: "NFTs y Arte Digital", duration: 345, reward: 0.5, emoji: "üé®", category: "Tendencias" },
                { id: 8, title: "DeFi: Finanzas Descentralizadas", duration: 540, reward: 0.9, emoji: "üè¶", category: "DeFi" },
            ],

            init() {
                this.server = new StellarSdk.Horizon.Server('https://horizon-testnet.stellar.org');
                // Si la URL incluye ?show=dashboard mostramos el dashboard aunque no haya sesi√≥n
                const params = new URLSearchParams(window.location.search);
                if (params.get('show') === 'dashboard') {
                    // Mantener publicKey si ya est√° en localStorage
                    const savedKey = localStorage.getItem('stellarPublicKey');
                    if (savedKey) this.publicKey = savedKey;
                    this.showDashboard();
                } else {
                    this.checkLoginState();
                }
            },

            checkLoginState() {
                const savedKey = localStorage.getItem('stellarPublicKey');
                if (savedKey) {
                    this.publicKey = savedKey;
                    this.showDashboard();
                } else {
                    this.showLogin();
                }
            },

            showLogin() {
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('dashboardPage').style.display = 'none';
                document.getElementById('videoPage').style.display = 'none';
            },

            showDashboard() {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboardPage').style.display = 'block';
                document.getElementById('videoPage').style.display = 'none';
                this.loadBalance();
                this.renderVideos();
                this.updateStats();
            },

            showVideo(videoId) {
                const video = this.videos.find(v => v.id === videoId);
                if (!video) return;

                this.currentVideoId = videoId;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboardPage').style.display = 'none';
                document.getElementById('videoPage').style.display = 'block';

                document.getElementById('videoTitle').textContent = `üì∫ ${video.title}`;
                document.getElementById('videoReward').textContent = `‚≠ê Recompensa: ${video.reward} XLM`;
                document.getElementById('videoEmoji').textContent = video.emoji;
                
                this.startVideo(video);
            },

            async connectFreighter() {
                const connectBtn = document.getElementById('connectBtn');
                const loading = document.getElementById('loading');
                
                try {
                    if (typeof window.freighterApi === 'undefined') {
                        this.showNotification('‚ö†Ô∏è Freighter no est√° instalado. Redirigiendo...', 'error');
                        setTimeout(() => {
                            window.open('https://www.freighter.app/', '_blank');
                        }, 2000);
                        return;
                    }

                    connectBtn.disabled = true;
                    connectBtn.textContent = '‚è≥ Conectando...';
                    loading.style.display = 'block';

                    const isConnected = await window.freighterApi.isConnected();
                    
                    if (!isConnected) {
                        this.showNotification('‚ö†Ô∏è Por favor, desbloquea Freighter Wallet', 'error');
                        connectBtn.disabled = false;
                        connectBtn.innerHTML = 'üîó Conectar con Freighter Wallet';
                        loading.style.display = 'none';
                        return;
                    }

                    try {
                        this.publicKey = await window.freighterApi.getPublicKey();
                    } catch (error) {
                        if (error.message.includes('User declined')) {
                            this.showNotification('‚ùå Conexi√≥n rechazada', 'error');
                            connectBtn.disabled = false;
                            connectBtn.innerHTML = 'üîó Conectar con Freighter Wallet';
                            loading.style.display = 'none';
                            return;
                        }
                        throw error;
                    }
                    
                    localStorage.setItem('stellarPublicKey', this.publicKey);
                    localStorage.setItem('loginTime', new Date().toISOString());
                    
                    this.showNotification('‚úÖ Conexi√≥n exitosa! Redirigiendo...', 'success');
                    
                    await this.checkBalance();
                    
                    setTimeout(() => {
                        this.showDashboard();
                    }, 1500);
                    
                } catch (error) {
                    console.error('Error:', error);
                    this.showNotification('‚ùå Error: ' + error.message, 'error');
                    connectBtn.disabled = false;
                    connectBtn.innerHTML = 'üîó Conectar con Freighter Wallet';
                    loading.style.display = 'none';
                }
            },

            async loadBalance() {
                try {
                    const account = await this.server.loadAccount(this.publicKey);
                    const xlmBalance = account.balances.find(b => b.asset_type === 'native');
                    const balance = parseFloat(xlmBalance.balance).toFixed(2);
                    document.getElementById('balanceDisplay').textContent = `üí∞ ${balance} XLM`;
                } catch (error) {
                    document.getElementById('balanceDisplay').textContent = 'üí∞ 0.00 XLM';
                    if (error.response && error.response.status === 404) {
                        this.showNotification('‚ö†Ô∏è Cuenta no financiada. Necesitas XLM de prueba', 'error');
                    }
                }
            },

            async checkBalance() {
                try {
                    const account = await this.server.loadAccount(this.publicKey);
                    const xlmBalance = account.balances.find(b => b.asset_type === 'native');
                    const balance = parseFloat(xlmBalance.balance).toFixed(2);
                    console.log('Balance:', balance, 'XLM');
                } catch (error) {
                    if (error.response && error.response.status === 404) {
                        this.showNotification('‚ö†Ô∏è Cuenta no financiada. Necesitas XLM de prueba', 'error');
                    }
                }
            },

            renderVideos() {
                const grid = document.getElementById('videosGrid');
                grid.innerHTML = this.videos.map(video => `
                    <div class="video-card" onclick="app.showVideo(${video.id})">
                        <div class="video-thumbnail">
                            <span>${video.emoji}</span>
                            <div class="play-button">‚ñ∂Ô∏è</div>
                        </div>
                        <div class="video-info">
                            <div class="video-title">${video.title}</div>
                            <div class="video-meta">
                                <span>‚è±Ô∏è ${Math.floor(video.duration / 60)}:${String(video.duration % 60).padStart(2, '0')}</span>
                                <span>üìÅ ${video.category}</span>
                            </div>
                            <div class="reward-badge">
                                ‚≠ê +${video.reward} XLM
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            updateStats() {
                const stats = this.getStats();
                document.getElementById('videosWatched').textContent = stats.videosWatched;
                document.getElementById('totalEarned').textContent = stats.totalEarned.toFixed(2) + ' XLM';
            },

            getStats() {
                return JSON.parse(localStorage.getItem('userStats') || '{"videosWatched": 0, "totalEarned": 0}');
            },

            startVideo(video) {
                this.timeWatched = 0;
                document.getElementById('timer').textContent = '00:00';
                document.getElementById('progressFill').style.width = '0%';
                
                this.videoInterval = setInterval(() => {
                    this.timeWatched++;
                    this.updateVideoTimer();
                    this.updateVideoProgress(video.duration);
                    
                    if (this.timeWatched >= video.duration) {
                        this.completeVideo(video);
                    }
                }, 1000);
            },

            updateVideoTimer() {
                const mins = Math.floor(this.timeWatched / 60);
                const secs = this.timeWatched % 60;
                document.getElementById('timer').textContent = 
                    String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
            },

            updateVideoProgress(totalTime) {
                const progress = (this.timeWatched / totalTime) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
            },

            completeVideo(video) {
                clearInterval(this.videoInterval);
                document.getElementById('rewardInfo').textContent = 
                    `üéâ ¬°Video completado! Has ganado ${video.reward} XLM`;
                
                const stats = this.getStats();
                stats.videosWatched++;
                stats.totalEarned += video.reward;
                localStorage.setItem('userStats', JSON.stringify(stats));
                
                this.showNotification(`‚úÖ Recompensa de ${video.reward} XLM agregada a tu cuenta!`, 'success');
                
                setTimeout(() => {
                    this.goToDashboard();
                }, 3000);
            },

            goToDashboard() {
                if (this.videoInterval) {
                    clearInterval(this.videoInterval);
                }
                this.showDashboard();
                // Si no est√° conectado, mostrar un aviso para conectar Freighter y explicar que se necesita para cobrar
                if (!this.publicKey) {
                    const container = document.getElementById('mainContainer');
                    if (container && !document.getElementById('connectNotice')) {
                        const notice = document.createElement('div');
                        notice.id = 'connectNotice';
                        notice.style.background = 'linear-gradient(135deg, #fff9c4, #fff3e0)';
                        notice.style.border = '1px solid #ffd54f';
                        notice.style.padding = '1rem';
                        notice.style.borderRadius = '10px';
                        notice.style.marginBottom = '1rem';
                        notice.innerHTML = `
                            <strong>‚ö†Ô∏è Para ganar recompensas necesitas conectar Freighter Wallet.</strong>
                            <div style="margin-top:0.5rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
                                <button class="btn btn-freighter" onclick="document.getElementById('connectBtn').click()">Conectar Freighter</button>
                                <a href="https://www.freighter.app/" target="_blank" class="btn" style="background:#667eea;color:white;border-radius:25px;padding:0.8rem 1.2rem;text-decoration:none;">Descargar Freighter</a>
                            </div>
                        `;
                        container.prepend(notice);
                    }
                } else {
                    // quitar aviso si existe
                    const existing = document.getElementById('connectNotice');
                    if (existing) existing.remove();
                }
            },

            logout() {
                localStorage.removeItem('stellarPublicKey');
                localStorage.removeItem('loginTime');
                this.publicKey = null;
                this.showLogin();
                this.showNotification('üëã Sesi√≥n cerrada', 'info');
            },

            showNotification(message, type) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = 'notification ' + type;
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            }
        };

        // Initialize app on load
        window.addEventListener('load', () => {
            app.init();
        });
    </script>
</body>
</html>